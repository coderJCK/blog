<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´ªåƒè›‡</title>
  <style>
    /* æ ·å¼åˆå§‹åŒ– */
    * {
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0 auto;
      overflow: hidden;
    }

    #app {
      width: 362px;
      height: 100%;
      margin: auto;
      overflow: auto;
    }

    ::-webkit-scrollbar {
      width: 0px;
    }

    #info {
      width: 100%;
      height: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* åœ°å›¾æ ·å¼ */
    #map {
      width: 360px;
      height: 360px;
      margin: 0 auto;
      border: 1px solid black;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      align-content: center;
      overflow: hidden;
      position: relative;
    }

    /* ä¸€è¡Œæ ¼å­çš„ç›’å­ */
    .divRow {
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .dialog {
      width: 100px;
      height: 100px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      line-height: 100px;
      color: rgb(217, 128, 128);
      background-color: rgba(125, 124, 124, 0.505);
      display: none;
    }

    .finishDialog {
      width: 120px;
      line-height: 30px;
      box-sizing: border-box;
      padding: 20px 5px;
    }

    /* æ“ä½œæ  */
    #control {
      width: 100%;
      height: 50px;
      display: flex;
      justify-content: space-between;
      box-sizing: border-box;
      padding: 0 10px;
      align-items: center;
    }

    .btn {
      width: 80px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }

    .startBtn {
      background-color: rgba(56, 227, 124, 0.54);
    }

    .restartBtn {
      background-color: rgba(246, 126, 126, 0.548);
    }

    .stopBtn {
      background-color: rgba(209, 200, 35, 0.548);
    }

    /* æ–¹å‘æ§åˆ¶ */
    .keyboard {
      margin: 10px auto;
      width: 50%;
      height: 120px;
      display: flex;
      box-sizing: border-box;
      padding: 0 10px;
      position: relative;
    }

    .keyboard>div {
      position: absolute;
      width: 40px;
      height: 40px;
      font-size: 40px;
      line-height: 40px;
    }

    .up {
      top: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .down {
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .left {
      top: 50%;
      left: 0;
      transform: translateY(-50%);
    }

    .right {
      top: 50%;
      right: 0;
      transform: translateY(-50%);
    }

    /* è¯´æ˜ */
    .tips {
      font-size: 14px;
      color: #666;
      height: 100px;
    }
  </style>
</head>
<!--  -->

<body>
  <div id="app">
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div id="info">
      <div>å†å²æœ€é«˜:<span class="maxScore"></span></div>
      <div>å½“å‰åˆ†æ•°:<span class="curScore">0</span></div>
    </div>
    <!-- åœ°å›¾ -->
    <div id="map">
      <div class="stopDialog dialog">æ¸¸æˆå·²æš‚åœ!</div>
      <div class="finishDialog dialog"></div>
    </div>
    <!-- æ“ä½œæ  -->
    <div id="control">
      <div class="restartBtn btn">é‡æ–°å¼€å§‹</div>
      <div class="startBtn btn">å¼€å§‹æ¸¸æˆ</div>
      <div class="stopBtn btn">æš‚åœæ¸¸æˆ</div>
    </div>
    <div class="keyboard">
      <div class="up" onclick="keyDown(38)">â¬†ï¸</div>
      <div class="down" onclick="keyDown(40)">â¬‡ï¸</div>
      <div class="left" onclick="keyDown(37)">â¬…ï¸</div>
      <div class="right" onclick="keyDown(39)">â¡ï¸</div>
    </div>
    <div class="tips">
      æ¸¸æˆè¯´æ˜: å›è½¦é”®â€”â€”å¼€å§‹æ¸¸æˆ;<br>
      &emsp;&emsp;&emsp;&emsp;&ensp;ä¸Šä¸‹å·¦å³é”®ç›˜â€”â€”ç§»åŠ¨;<br>
      &emsp;&emsp;&emsp;&emsp;&ensp;ç©ºæ ¼é”®â€”â€”æš‚åœ;<br>
    </div>
  </div>
  <script>
    // åœ°å›¾ä¿¡æ¯
    var mapInfo = {
      x: 30, // æ¨ªå‘å°æ ¼å­æ•°é‡
      y: 30,  // çºµå‘å°æ ¼å­æ•°é‡
      size: 11, // å°æ ¼å­å¤§å°
      color: "papayawhip", // å°æ ¼å­é¢œè‰²
      arrMap: [],  // æ‰€æœ‰çš„å°æ ¼å­èŠ‚ç‚¹
    };
    // ğŸä¿¡æ¯
    var snakeInfo = {
      x: [], // ğŸèº«ä½“çš„æ¨ªåæ ‡
      y: [], // ğŸèº«ä½“çš„çºµåæ ‡
      direction: 37, // ğŸèº«ä½“çš„æ–¹å‘
      bodyColor: "skyblue", // ğŸèº«ä½“é¢œè‰²
      headColor: "red", // ğŸå¤´éƒ¨é¢œè‰²
      length: 3, // ğŸèº«ä½“é•¿åº¦
    }
    // é”®ç›˜
    const KeyCode = {
      left: 37,
      up: 38,
      right: 39,
      down: 40,
    }
    // é£Ÿç‰©ä¿¡æ¯
    var foodInfo = {
      x: 9, // é£Ÿç‰©çš„æ¨ªåæ ‡
      y: 3, // é£Ÿç‰©çš„çºµåæ ‡
      color: "green", // é£Ÿç‰©é¢œè‰²
    }
    var isStop = false;  // æ˜¯å¦æš‚åœ
    var Dom = {
      curScore: document.querySelector(".curScore"), // å½“å‰åˆ†æ•°
      maxScore: document.querySelector(".maxScore"), // æœ€é«˜åˆ†æ•°
      startBtn: document.querySelector(".startBtn"), // å¼€å§‹æŒ‰é’®
      stopBtn: document.querySelector(".stopBtn"), // æš‚åœæŒ‰é’®
      restartBtn: document.querySelector(".restartBtn"), // é‡æ–°å¼€å§‹æŒ‰é’®
      stopDialog: document.querySelector(".stopDialog"), // æš‚åœå¼¹çª—
      finishDialog: document.querySelector(".finishDialog"), // ç»“æŸå¼¹çª—
    }

    // å‡½æ•°è‡ªè°ƒç”¨
    window.onload = function () {
      createMap();  // åˆ›å»ºåœ°å›¾
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»æŒ‰é’®ä¹‹åï¼Œå›è½¦é”®ä¼šå’ŒæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¼šäº§ç”Ÿå…³è”
      Dom.startBtn.onclick = init;  // å¼€å§‹æ¸¸æˆ
      Dom.curScore.innerHTML = snakeInfo.length - 3; //å½“å‰åˆ†æ•°
      Dom.maxScore.innerHTML = localStorage.getItem("maxScore") || 'æš‚æ— è®°å½•'; //æœ€é«˜åˆ†æ•°
      document.onkeydown = keyDown; //ç›‘å¬é”®ç›˜äº‹ä»¶
      Dom.stopBtn.onclick = function () {
        stopGame();
      }
      Dom.restartBtn.onclick = function () {
        Dom.finishDialog.style.display = "none";
        if (snakeInfo.x.length == 0) {
          init();
          return;
        };
        clearSnake(snakeInfo.x, snakeInfo.y); // æ¸…é™¤è›‡èº«
        reSet();
        init();
      }
    }
    /**
     * åˆå§‹åŒ–
     */
    function init() {
      if (snakeInfo.x.length == 0) {
        Dom.finishDialog.style.display = "none";
        Dom.stopDialog.style.display = "none";
        createSnake();  // åˆ›å»ºè›‡èº«
        createFood(); //åˆ›å»ºé£Ÿç‰©
        move = setInterval("snakeMove()", 200); //æ¯ä¸ªä¸¤ç™¾ç§’è›‡èº«ç§»åŠ¨
      }
    }
    /**
     * åˆå§‹åœ°å›¾
     */
    function createMap() {
      var map = document.getElementById("map");
      for (y = 0; y < mapInfo.y; y++) {
        let divRow = document.createElement("div");
        divRow.className = "divRow";
        //åˆ›å»ºä¸€è¡Œ
        for (x = 0; x < mapInfo.x; x++) {
          divRow.innerHTML += `
          <div class="divDot" style="
            width:${mapInfo.size}px;
            height:${mapInfo.size}px;
            background:${mapInfo.color}"></div>
        `;
        }
        map.appendChild(divRow);  // èŠ‚ç‚¹æ·»åŠ åˆ°åœ°å›¾ä¸­
        mapInfo.arrMap.push(divRow);  // èŠ‚ç‚¹æ·»åŠ åˆ°åœ°å›¾æ•°ç»„ä¸­
      }
    }
    /**
     * éšæœºç”Ÿæˆè›‡çš„ä½ç½®
     */
    function createSnake() {
      var result; //åˆ¤æ–·æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆé£Ÿç‰©
      // ä¿æŒè›‡éšæœºå‡ºç°åœ¨åœ°å›¾1/4~3/4çš„ä½ç½®ï¼Œé˜²æ­¢åˆšå‡ºæ¥å°±æ’å¢™
      const maxRow = mapInfo.x * 3 / 4;
      const minRow = mapInfo.x / 4;
      const maxCol = mapInfo.y * 3 / 4;
      const minCol = mapInfo.y / 4;
      // éšæœºæ–¹å‘
      const directionArr = Object.values(KeyCode);
      snakeInfo.direction = directionArr[Math.floor(Math.random() * directionArr.length)];
      // éšæœºxåæ ‡ä½ç½®
      snakeInfo.x[0] = Math.round(Math.random() * (maxRow - minRow) + minRow);
      // éšæœºyåæ ‡ä½ç½®
      snakeInfo.y[0] = Math.round(Math.random() * (maxCol - minCol) + minCol);
      for (i = 1; i < snakeInfo.length; i++) {
        switch (snakeInfo.direction) {
          case KeyCode.up:
            snakeInfo.x[i] = snakeInfo.x[0];
            snakeInfo.y[i] = snakeInfo.y[0] + i;
            break;
          case KeyCode.down:
            snakeInfo.x[i] = snakeInfo.x[0];
            snakeInfo.y[i] = snakeInfo.y[0] - i;
            break;
          case KeyCode.left:
            snakeInfo.x[i] = snakeInfo.x[0] + i;
            snakeInfo.y[i] = snakeInfo.y[0];
            break;
          case KeyCode.right:
            snakeInfo.x[i] = snakeInfo.x[0] - i;
            snakeInfo.y[i] = snakeInfo.y[0];
            break;
          default:
            break;
        }
      }
    }
    function reSet() {
      mapInfo.arrMap[foodInfo.y].children[foodInfo.x].style.background = mapInfo.color; // æ¸…é™¤é£Ÿç‰©
      clearInterval(move);
      snakeInfo.x = [];
      snakeInfo.y = [];
      snakeInfo.direction = 37;
      snakeInfo.length = 3;
      Dom.curScore.innerHTML = snakeInfo.length - 3;
      isStop = false;
    }
    /**
     * æ¸²æŸ“è›‡èº«
     */
    function parseSnake() {
      const arrX = [...snakeInfo.x];
      const arrY = [...snakeInfo.y];
      mapInfo.arrMap[arrY[0]].children[arrX[0]].style.background = snakeInfo.headColor;
      for (i = 1; i < arrY.length; i++) {
        const row = mapInfo.arrMap[arrY[i]];
        row.children[arrX[i]].style.background = snakeInfo.bodyColor;
      }
    }
    /**
     * æ¸…é™¤è›‡èº«
     * @param {Array} arrX è›‡èº«xåæ ‡æ•°ç»„
     * @param {Array} arrY è›‡èº«yåæ ‡æ•°ç»„
     */
    function clearSnake(arrX, arrY) {
      for (i = 0; i < arrY.length; i++) {
        const row = mapInfo.arrMap[arrY[i]];
        row.children[arrX[i]].style.background = mapInfo.color;
      }
    }

    /**
     * è›‡èº«ç§»åŠ¨
     */
    function snakeMove() {
      // ç§»åŠ¨å‰ä½ç½®
      let oldX = [...snakeInfo.x];
      let oldY = [...snakeInfo.y];
      // è›‡èº«ä½ç½®ä¸ºç§»åŠ¨å‰çš„è›‡èº«å‰ä¸€èŠ‚çš„ä½ç½®
      for (let i = 1; i < snakeInfo.length; i++) {
        snakeInfo.x[i] = oldX[i - 1];
        snakeInfo.y[i] = oldY[i - 1];
      }
      // ä»…è›‡å¤´ä½ç½®å˜åŒ–
      switch (snakeInfo.direction) {
        case KeyCode.up:
          snakeInfo.y[0] -= 1;
          break;
        case KeyCode.down:
          snakeInfo.y[0] += 1;
          break;
        case KeyCode.left:
          snakeInfo.x[0] -= 1;
          break;
        case KeyCode.right:
          snakeInfo.x[0] += 1;
          break;
        default:
          break;
      }
      // åˆ¤æ–­æ˜¯å¦åƒåˆ°è‡ªå·±
      const condition1 = snakeInfo.x.slice(3).some((item, index) => {
        return (item == snakeInfo.x[0]) && (snakeInfo.y[index + 3] == snakeInfo.y[0]);
      });
      // åˆ¤æ–­æ˜¯å¦è›‡å¤´æ’å¢™
      const condition2 = (snakeInfo.direction == KeyCode.up || KeyCode.down) &&
        (snakeInfo.x[0] < 0 || snakeInfo.x[0] >= mapInfo.x);
      const condition3 = (snakeInfo.direction == KeyCode.left || KeyCode.right) &&
        (snakeInfo.y[0] < 0 || snakeInfo.y[0] >= mapInfo.y);
      if (condition1 || condition2 || condition3) {
        const score = snakeInfo.length - 3;
        clearSnake(oldX, oldY); // æ¸…é™¤è›‡èº«
        reSet();
        Dom.finishDialog.style.display = "block";
        Dom.finishDialog.innerHTML = "æ¸¸æˆç»“æŸ<br>æ‚¨çš„å¾—åˆ†ä¸º" + (score);
        if (!localStorage.getItem("maxScore")) {
          localStorage.setItem("maxScore", score);
          Dom.maxScore.innerHTML = score;
        }
        if (localStorage.getItem("maxScore") < score) {
          localStorage.setItem("maxScore", score);
          Dom.maxScore.innerHTML = score;
        }
        return;
      }
      // åˆ¤æ–­æ˜¯å¦åƒåˆ°é£Ÿç‰©
      if (snakeInfo.x[0] == foodInfo.x && snakeInfo.y[0] == foodInfo.y) {
        snakeInfo.length++; // è›‡èº«é•¿åº¦åŠ 1
        // åƒåˆ°é£Ÿç‰©å‰çš„è›‡å°¾åæ ‡
        snakeInfo.x.push(oldX[oldX.length - 1]);
        snakeInfo.y.push(oldY[oldY.length - 1]);
        createFood();
      }
      //æ¸…é™¤åŸè›‡èº«
      clearSnake(oldX, oldY);
      //é‡æ–°æ¸²æŸ“è›‡èº«
      parseSnake();
      Dom.curScore.innerHTML = snakeInfo.length - 3; //å½“å‰åˆ†æ•°
    }

    /**
     * åˆ›å»ºé£Ÿç‰©
     */
    function createFood() {
      do {
        result = false;
        foodInfo.x = Math.floor(Math.random() * mapInfo.x);
        foodInfo.y = Math.floor(Math.random() * mapInfo.y);
        // å¦‚æœå‡ºç°åœ¨è›‡èº«ä¸Šï¼Œåˆ™é‡æ–°ç”Ÿæˆ
        if (snakeInfo.x.includes(foodInfo.x) && snakeInfo.y.includes(foodInfo.y)) {
          result = true;
          continue;
        }
        const row = mapInfo.arrMap[foodInfo.y];
        row.children[foodInfo.x].style.background = foodInfo.color;
      } while (result);
      // ä¸æ»¡è¶³æ¡ä»¶ï¼Œç»“æŸå¾ªç¯
    }
    /**
     * é”®ç›˜äº‹ä»¶
     * @param {number || Object}  é”®ç›˜æŒ‰é”®
     */
    function keyDown(event) {
      let newKey;
      if (typeof event == 'number') {
        newKey = event;
      } else {
        newKey = event.keyCode;
      }
      const oldKey = snakeInfo.direction; //è›‡å½“å‰æ–¹å‘
      // å¼€å§‹æ¸¸æˆ
      if (newKey == '13') {
        init();
      };
      if (snakeInfo.x.length == 0) return;
      if (isStop) return;
      // ç¦æ­¢æ‰å¤´
      if (oldKey == KeyCode.left && newKey == KeyCode.right) return;
      if (oldKey == KeyCode.right && newKey == KeyCode.left) return;
      if (oldKey == KeyCode.up && newKey == KeyCode.down) return;
      if (oldKey == KeyCode.down && newKey == KeyCode.up) return;
      // æš‚åœ
      if (newKey == '32') {
        stopGame();
        return;
      }
      // æŒ‰é”®å¿…é¡»æ˜¯ä¸Šä¸‹å·¦å³
      if (Object.values(KeyCode).includes(newKey)) {
        snakeInfo.direction = newKey;
        clearInterval(move);
        move = setInterval("snakeMove()", 200); //æ¯ä¸ªä¸¤ç™¾ç§’è›‡èº«ç§»åŠ¨
      }
    }
    /**
     * æš‚åœæ¸¸æˆ
     */
    function stopGame() {
      if (snakeInfo.x.length == 0) return;
      isStop = !isStop;
      if (isStop) {
        clearInterval(move);
        Dom.stopDialog.style.display = "block";
      } else {
        Dom.stopDialog.style.display = "none";
        move = setInterval("snakeMove()", 200); //æ¯ä¸ªä¸¤ç™¾ç§’è›‡èº«ç§»åŠ¨
      }
    }
  </script>
</body>

</html>